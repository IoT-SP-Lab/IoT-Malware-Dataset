import datetime
from os import listdir
import shutil
import subprocess
from os.path import isfile, join
import requests
import json
import time
import os

api_key = ""


def get_metadata(md5):
    data = {}
    req = requests.get("https://www.virustotal.com/api/v3/search?query=" +
                       md5, headers={'x-apikey': api_key})
    if(req.status_code == 200):
        json_format = req.json()
        data['md5'] = json_format['data'][0]['attributes']['md5']
        data['malicious_votes'] = json_format['data'][0]['attributes']['last_analysis_stats']['malicious']
        data['first_submission_date'] = json_format['data'][0]['attributes']['first_submission_date']
        data['last_submission_date'] = json_format['data'][0]['attributes']['last_submission_date']
        data['magic'] = json_format['data'][0]['attributes']['magic']
        data['size'] = json_format['data'][0]['attributes']['size']
        data['type'] = json_format['data'][0]['attributes']['type_description']
        data['magic'] = json_format['data'][0]['attributes']['magic']
        data['size'] = json_format['data'][0]['attributes']['size']

        if 'popular_threat_classification' in json_format['data'][0]['attributes']:
            data['threat_label'] = json_format['data'][0]['attributes']['popular_threat_classification']['suggested_threat_label']
        else:
            data['threat_label'] = 'benign'

        if 'elf_info' in json_format['data'][0]['attributes']:
            data['architecture'] = json_format['data'][0]['attributes']['elf_info']['header']['machine']
            data['entrypoint'] = json_format['data'][0]['attributes']['elf_info']['header']['entrypoint']
        else:
            data['architecture'] = '<unknown>'
            data['entrypoint'] = ""
    else:
        print(req.status_code)
    return data


def get_magic_data(md5):
    data = {}
    req = requests.get("https://www.virustotal.com/api/v3/search?query=" +
                       md5, headers={'x-apikey': api_key})
    if(req.status_code == 200):
        json_format = req.json()
        data['magic'] = json_format['data'][0]['attributes']['magic']
        data['size'] = json_format['data'][0]['attributes']['size']
    else:
        print(req.status_code)
    return data
